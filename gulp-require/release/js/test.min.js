require(["ajax","globalConfig","mustache","grid","imageviewer","jqExtend","imageLoaded","jqform","fader","tabPanel","blockUI","jquery","bootstrap","domReady!"],function(a,e,t,n){console.log("win:domread");var o=function(){this.init()};o.prototype={init:function(){var a=this;a.firstLoad(),a.buildDom(),a.bindEvent(),a.load()},buildDom:function(){var a=this;a.$carousel=$("#carousel"),a.carouselHtml=$("#carousel_template").html(),a.$thumbnailModal=$("#thumbnail_modal"),a.$modalImg=a.$thumbnailModal.find("[data-field='modal-img']"),a.$waterFall=$("#waterfull_content"),a.waterFallTemplate=$("#waterfull_content_template").html(),a.page={limit:10,pageIndex:1,isFocusPhoto:!1,hasRecords:!0},a.loadGlobalFlag=!1},bindEvent:function(){var a,e=this;e.$thumbnailModal.on("show.bs.modal",function(a){var t=$(a.relatedTarget).closest("[data-field='idx']").find("img[data-field='content']"),n=t.attr("src");e.$modalImg.attr("src",$.dataBase64Img),e.$modalImg.attr("src",n)}),e.$waterFall.on("click","[data-action]",function(){var a=$(this).attr("data-action"),t=$(this).closest("a").find("[data-field='content']");switch(a){case"zhan":break;case"love":break;case"fullscreen":var n=t.data("high-res-src");e.viewer||(e.viewer=ImageViewer()),e.viewer.show(t.attr("src"),n)}}),$(window).on("resize",$.debounce(function(){e.initWaterFall()},300)),$(window).on("scroll",function(){e.scrollload(a)})},load:function(){var a=this;a.carousel(),a.mainContent(a.page)},initComponent:function(){},carousel:function(){var t=this;a.invoke({url:e.paths.loadPhotoDetail,contentType:"application/json",data:JSON.stringify({isFocusPhoto:!0}),beforeSend:function(){t.$carousel.block({css:{border:"none",width:50,height:50,background:"transparent"},message:$.initBlockMsg()})},complete:function(){t.$carousel.unblock()},success:function(a){t.render(a)},failed:function(a){$.messageAlert(a.reason)}})},mainContent:function(t){var n=this;a.invoke({url:e.paths.loadPhotoDetail,data:t,beforeSend:function(){$.blockUI({css:{border:"none",background:"transparent"},message:$.initBlockMsg()})},complete:function(){$.unblockUI()},success:function(a){n.renderMaincontent(a)},failed:function(a){$.messageAlert(a.reason)}});var o=$.extend({},n.page,{pageIndex:n.page.pageIndex+1});n.preMainPhoto(o)},preMainPhoto:function(t){a.invoke({url:e.paths.loadPhotoDetail,data:t,success:function(a){$.each(a.data,function(a,e){var t=new Image;t.onload=function(){console.log("=========="+this.src)},t.src="/data/photo/"+e.imgguid})},failed:function(a){consloe.log(a.reason)}})},render:function(a){var e,n=this,o=a.data,i=0,l=[],r="active";for(o.length=o.length>10?10:o.length;i<o.length;i++)l.push({idx:i,cls:r}),o[i].cls=r,r="";l.length=o.length,a.list=l,a.data=o,e=t.render(n.carouselHtml,{Data:a}),n.$carousel.append(e),n.preLoad(n.$carousel.find("img[data-field='content']"))},renderMaincontent:function(a){var e,n,o=this,i=(a.data,o.$waterFall.find("[data-field='idx']").last().index());o.page.hasRecords=a.hasRecords,n=t.render(o.waterFallTemplate,{Data:a}),o.$waterFall.append(n),e=0>i?o.$waterFall.find("[data-field='idx']"):o.$waterFall.find("[data-field='idx']:gt("+(i-1)+")"),o.preLoad(e.find("img[data-field='content']"),void 0,function(){o.initWaterFall()})},firstLoad:function(){var a=this,e=a.createProgress();a.preLoad($("img").filter("[src!='']"),e)},scrollload:function(a){var e=this,t=$(window).height(),n=$(window).scrollTop(),o=$(document).height();if(t+n==o){a&&clearTimeout(a);var i=function(){return e.page.hasRecords?(e.page.pageIndex++,void e.mainContent(e.page)):(e.loadGlobalFlag=!0,$.messageAlert("It's last page and not records"))};e.loadGlobalFlag||setTimeout(i,300)}},preLoad:function(a,e,t){var n,o=this,i=0;a.imagesLoaded({progress:function(a,e,t,o){n=(t.length+o.length)/e.length*100;t.length+o.length},done:function(a){},always:function(l,r,d,c){if("function"==typeof t&&a.size()&&t.call(o),void 0!=e)var s=setInterval(function(){void 0!=n&&(n>=i?e.$barpanel.width(i++ +"%"):100==n?(e.$barpanel.parent().fadeOut("slow",function(){$(this).remove(),e.$modal.remove()}),i=0,clearInterval(s)):clearInterval(s))},30)},fail:function(a,e,t){var n=[];t.each(function(a,e){n.push(e.src),$(e).attr("src",$.dataBase64Img),$(e).attr("src","/res/images/nopic.png")}),console.log("fail:"+n.join("\n	"))}})},createProgress:function(){var a=$("<div><div id='rect' style='background:#ccc; height: 5px; width: 0%;overflow:hidden;color:white;border-radius:4px;text-align:center;box-shadow:0 0 20px;'></div></div>");a.css({width:"100%",height:"5px",position:"fixed",top:"70%",left:0,"border-radius":"4px",background:"#222","z-index":1e4}).appendTo("body");var e=$("<div></div>");return e.css({top:0,left:0,right:0,bottom:0,background:"#000",opacity:".95",position:"fixed","z-index":9999}).appendTo("body"),{$modal:e,$barpanel:a.children()}},initWaterFall:function(){var a=this;a.$waterFall.waterfall()}},new o});